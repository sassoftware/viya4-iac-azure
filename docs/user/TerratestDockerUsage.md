# Using the Terratest Docker Container

Use the Terratest Docker container to run the suite of Terratest Go tests. For more information on Terratest, follow the [Documentation](https://terratest.gruntwork.io/docs/) page. The Terratest Docker image is used by the [Github Workflow](../../.github/workflows/default_plan_unit_tests.yml) as a required check before merging changes.

## Prereqs

- Docker [installed on your workstation](../../README.md#docker).

## Preparation

### Docker image

Run the following command to create the `viya4-iac-azure-terratest` Docker image using the provided [Dockerfile.terratest](../../Dockerfile.terratest)

```bash
docker build -t viya4-iac-azure-terratest -f Dockerfile.terratest .
```

The Docker image `viya4-iac-azure-terratest` will contain Terraform and Go executables, as well as the required Go modules. The Docker entrypoint for the image is `go test` and accepts several optional command line arguments. For more information on command line arguments, please see [Command Line Arguments](#command-line-arguments).

### Docker Environment File for Azure Authentication

Follow either one of the authentication methods described in [Authenticating Terraform to access Azure](./TerraformAzureAuthentication.md) and create a file with the authentication variable values to use with container invocation. Store these values outside of this repo in a secure file, for example
`$HOME/.azure_docker_creds.env.` Protect that file with Azure credentials so only you have read access to it. **NOTE:** Do not use quotes around the values in the file, and make sure to avoid any trailing blanks!

Now each time you invoke the container, specify the file with the [`--env-file`](https://docs.docker.com/engine/reference/commandline/run/#set-environment-variables--e---env---env-file) option to pass on Azure credentials to the container.

### Docker Volume Mounts

Add volume mounts to the `docker run` command for all files and directories that must be accessible from inside the container.
- `--volume="$(pwd)":/viya4-iac-azure` the project must be mounted to the /viya4-iac-azure directory.

## Command Line Arguments

The `terratest_docker_entrypoint.sh` script supports several command line arguments to customize the test execution. Here are the available options:

* `-p, --package=PACKAGE`: The package to test. Default is './...'
* `-r, --run=TEST`: The name of the test to run. Default is '.\*Plan.\*'.
* `-v, --verbose`: Run the tests in verbose mode.
* `-h, --help`: Display the help message.

## Running Terratest Commands

### Running the default tests

To run the default suite of unit tests (only terraform plan), run the following docker command:

```bash
# Run from the ./viya4-iac-azure directory
docker run --rm \
  --env-file=$HOME/.azure_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-azure \
  viya4-iac-azure-terratest
```

### Running a specific Go Test

To run a specific test, run the following docker command with the -r command line argument:

```bash
# Run from the ./viya4-iac-azure directory
docker run --rm \
  --env-file=$HOME/.azure_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-azure \
  viya4-iac-azure-terratest \
  -r="YourTest"
```
To run multiple tests, pass in a regex to the -r argument - "TestName1|TestName2|TestName3"

### Running a specific Go Package and Test

If you want to specify the Go package and test name, run the following docker command with the following arguments:

```bash
# Run from the ./viya4-iac-azure directory
docker run --rm \
  --env-file=$HOME/.azure_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-azure \
  viya4-iac-azure-terratest \
  -r="YourTest" \
  -p="YourPackage"
```

### Running the Go Tests with verbose mode

If you want to run the tests with verbose mode, run the docker image with the -v flag:

```bash
# Run from the ./viya4-iac-azure directory
docker run --rm \
  --env-file=$HOME/.azure_docker_creds.env \
  --volume "$(pwd)":/viya4-iac-azure \
  viya4-iac-azure-terratest -v
```

### Accessing test run logs

After running the docker container, log files will be created in the ./viya4-iac-azure/test/test_output directory. These will allow you to view the test results in xml as well as test logs generated by the terrratest_log_parser.
